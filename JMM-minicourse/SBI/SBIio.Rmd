---
title: "Simulation-Based Inference"
author: "R Pruim"
date: "JMM 2016"
output:
  ioslides_presentation:
    highlight: haddock
    widescreen: yes
  beamer_presentation: default
  slidy_presentation:
    highlight: pygments
    smart: no
---

## Simulation-Based Inference with mosaic

### You can do() it!

## Basic ideas

#### Traditional Approach
 * Sampling distributions approximated by theoretical distributions
 * parameters of these distributions are estimated from data
 * p-values and CIs based on formulas & estimated parameters
    
$$ t = \frac{ \overline{x} - \mu}{s / \sqrt{n}} $$

#### SBI Approach

 * Sampling distributions are approximated by simulation
 * p-values and CIs are computed from simulated data
 

## The Lady Tasting Tea

  * Often used on first day of class
 
  * Story
 
    * woman claims she can tell whether milk
   has been poured into tea or vice versa.
   
    * Question: How do we test this claim?
    
  * Can replace with any test of a proportion 
 
    * fair coin, Dorris and Buzz, multiple-choice guessing, ESP, Hugo, ...
   
```{r include = FALSE }
require(mosaic)
trellis.par.set(theme = col.mosaic())
require(knitr)
opts_chunk$set(cache = TRUE)
options(width = 110)
set.seed(12345)
```

```{r include = FALSE}
require(knitr)
opts_chunk$set( 
  fig.width = 8, 
  fig.height = 2,
  out.width = 800,
  out.height = 200,
  fig.align = "center"
  )
```

## Computer Simulation

Use `rflip()` to simulate flipping coins
```{r}
rflip()
```

## Computer Simulation

Faster if we flip multiple coins at once:
```{r} 
rflip(10)
```
 * easier to consider `heads` = correct; `tails` = incorrect than to compare with a given pattern
   * this switch bothers me more than it bothers my students

## Let's do that a lot of times

`rflip(10)` simulates 1 lady tasting 10 cups 1 time.

We can do that many times to see how guessing ladies do:
```{r}
do(2) * rflip(10)
```

 * `do()` is clever about what it remembers
 * 2 isn't many -- we'll do many next.

## The distribution of guessing ladies


```{r fig.width = 10, fig.height = 3, fig.align = "center"}
Ladies <- do(5000) * rflip(10)
head(Ladies, 1)
histogram( ~ heads, data = Ladies, width = 1 )
```

## How often does guessing score 9 or 10?

```{r}
tally( ~(heads >= 9) , data = Ladies)
```

## How often does guessing score 9 or 10?


```{r}
tally( ~(heads >= 9) , data = Ladies, 
                       format = "prop")
```

## How often does guessing score 9 or 10?


```{r}
tally( ~(heads >= 9) , data = Ladies, 
                       format = "prop")
 prop( ~(heads >= 9), data = Ladies)
```


## A general approach to randomization

### Three Step Program

 1. Do it for **your data**
 2. Do it for **random data**
 3. Do it **lots of** times for **random data**

definition of *it* is usually natural

definition of *random* is important ... but can often be handled by 
 
  * `shuffle()` or 
  * `resample()`

## Example: Is there a difference in means?


Data: `HELPrct`

Question: Do the mean ages of men and women differ?

  * Of course, there will be a difference in our data
  
  * Want to know whether that difference could be due merely to randomness
  
## Example: Do mean ages differ by sex?

```{r fig.width = 10, fig.height = 3, fig.align = "center"}
diffmean(age ~ sex, data = HELPrct)
bwplot( sex ~ age, data = HELPrct)
```


## Example: Do mean ages differ by sex?


```{r fig.width = 10, fig.height = 3, fig.align = "center"}
do(1) * 
  diffmean(age ~ shuffle(sex), data = HELPrct)
Null <- do(5000) * 
  diffmean(age ~ shuffle(sex), data = HELPrct)
```

## Example: Do mean ages differ by sex?


```{r fig.width = 10, fig.height = 3, fig.align = "center"}
2 * prop( ~ (diffmean <= -0.7841), data = Null)
histogram( ~ diffmean, data = Null, v = -.7841) 
```

## A Little Wrinkle


We should include the observed test statistic in the Null Distribution.

 * If the Null Hypothesis is true, the observed test statistic belongs
 * Avoids the problem of obtaining a p-value of 0

`prop`()` computes proportions after adding 1 to numerator and denominator. 

```{r}
2 * prop1( ~ (diffmean <= -0.7841), data = Null)
```


## Example:  Bootstrap for difference in means



```{r fig.width = 10, fig.height = 3, fig.align = "center"}
Bootstrap <- do(5000) * 
  diffmean(age ~ sex, data= resample(HELPrct))

histogram( ~ diffmean, data = Bootstrap, 
                      v = -.7841, glwd = 4 )
```

## Example:  CI for difference in mean ages

autosize: true

```{r fig.width = 10, fig.height = 3, fig.align = "center"}
cdata( ~ diffmean, data = Bootstrap, p = .95)
confint(Bootstrap, method = "quantile")
```

## Example:  CI for difference in mean ages

autosize: true

```{r}
confint(Bootstrap)  # default uses st. err
```

## Randomization and linear models


```{r size = "tiny"}
do(1) * lm(width ~ length, data = KidsFeet)
do(3) * lm(width ~ shuffle(length), data = KidsFeet)
```

## Randomization and linear models


```{r size = "tiny"}
do(1) * 
  lm(width ~ length + sex, data = KidsFeet)
do(3) * 
  lm( width ~ length + shuffle(sex), 
                       data = KidsFeet)
```


## Randomization and linear models


```{r fig.width = 10, fig.height = 3, fig.align = "center"}
Null <- do(5000) * 
  lm(width ~ length + shuffle(sex), data = KidsFeet)
histogram( ~ sex.G, data = Null, 
           v = -0.2325, glwd = 4)
```

## Randomization and linear models


```{r fig.width = 10, fig.height = 3, fig.align = "center"}
histogram(~ sex.G, data = Null, 
           v = -0.2325, glwd = 4)
prop1(~ (sex.G <= -0.2325), data = Null)
```

